# Regras e Know‑how do Projeto

## Stack & Arquitetura
- Backend: Ruby on Rails 7 + PostgreSQL + Sidekiq (`config/application.rb:36–87`).
- Frontend: Vue 3 + Vite + integração Rails via `vite-plugin-ruby` (`vite.config.ts:21–45`).
- Autenticação/Autorização: Devise + `devise_token_auth` + Pundit; suporte 2FA/SSO.
- Tempo real: ActionCable.
- Enterprise: extensões carregadas e injetadas no boot (`config/application.rb:41–53`, `config/initializers/01_inject_enterprise_edition_module.rb:23–87`).

## Pastas‑chave (guia rápido)
- `app/controllers/**`: APIs (`api/v1`, `api/v2`, `platform`, `public`) e web.
- `app/models/**`: entidades (Account, User, Conversation, Message, Inbox, Contact...).
- `app/services/**`: regras de negócio e integrações externas.
- `app/jobs/**`: tarefas assíncronas (Sidekiq) e manutenção.
- `app/channels/**`: ActionCable.
- `app/presenters/**`: formatação de saídas.
- `app/javascript/dashboard/**`: SPA (rotas, store, componentes, helpers).
- `config/**`: rotas, ambientes, inicializadores, Sidekiq e cron.

## Fluxo Web (SPA)
- Renderização do app: `DashboardController` com layout Vue e seleção de pack (`app/controllers/dashboard_controller.rb:11`, `78–84`).
- Configuração global e versão/GIT SHA: (`app/controllers/dashboard_controller.rb:21–41`, `62–76`), `config/initializers/git_sha.rb:16`.
- Rotas SPA: `root` e `/app` rendendo dashboard (`config/routes.rb:11–19`).
- Guarda de navegação: autenticação e permissões (`app/javascript/dashboard/routes/index.js:13–27`, `29–41`; `app/javascript/dashboard/helper/routeHelpers.js:56–77`).

## Convenções (Backend)
- Controllers finos; mover regra de negócio para Service Objects (`app/services/**`).
- Autorização via Pundit nas ações sensíveis.
- Assíncrono com Sidekiq; escolher fila adequada (`config/sidekiq.yml:17–34`).
- Tarefas recorrentes em `config/schedule.yml:6–55` (IMAP, housekeeping, auto‑assignment, etc.).
- Inicializadores condicionados por ENV (APM/monitoramento) (`config/application.rb:11–35`).
- Enterprise: usar injeção por `prepend/extend/include` conforme injector (`config/initializers/01_inject_enterprise_edition_module.rb:23–87`).
- Segurança: nunca expor segredos; usar ENV e ActiveRecord Encryption quando chaves existem (`config/application.rb:72–84`).

## Convenções (Frontend)
- Vue 3 + `vue-router@4` + `Vuex@4`; manter helpers de permissões/rotas (`app/javascript/dashboard/helper/routeHelpers.js:15–18`, `40–54`, `56–77`).
- Carregar usuário antes de navegação e redirecionar não autenticados para `/app/login` (`app/javascript/dashboard/routes/index.js:13–27`).
- Aliases de import padronizados (dashboard/shared/widget etc.) (`vite.config.ts:74–87`).
- Build do SDK em modo biblioteca com `BUILD_MODE=library` gerando `public/packs/js/sdk.js` (`vite.config.ts:26–43`, `45–73`).

## Lint & Qualidade
- Ruby: Rubocop com regras e cops customizados (`.rubocop.yml:1–10`, `198–200`).
  - Cop: exigir `from_email` em buscas por e‑mail (`rubocop/use_from_email.rb:4–15`).
- JS/Vue: ESLint + Prettier + regras Vue estritas (`.eslintrc.js:53–58`, `59–68`, `78–97`, `230–236`).
- Scripts úteis: `start:dev`, `start:test`, `ruby:prettier`, `build:sdk` (`package.json:11–16`).

## Build & Execução
- Dev: usar `foreman/overmind` para Rails, Sidekiq e Vite (`package.json:11–14`).
- SDK: `pnpm run build:sdk` ou `BUILD_MODE=library vite build` (`package.json:15`, `vite.config.ts:26–43`).
- Docker: imagem multi‑stage com assets pré‑compilados e `.git_sha` (`Dockerfile:83–91`).

## Referências rápidas
- Layout Vue e pack: `app/controllers/dashboard_controller.rb:11`, `78–84`.
- Config global: `app/controllers/dashboard_controller.rb:21–41`, `62–76`.
- Rotas SPA: `config/routes.rb:11–19`.
- Guarda de rotas: `app/javascript/dashboard/routes/index.js:13–27`, `29–41`.
- Permissões por conta: `app/javascript/dashboard/helper/routeHelpers.js:56–77`.
- Filas Sidekiq: `config/sidekiq.yml:17–34`.
- Cron jobs: `config/schedule.yml:6–55`.
- SDK build: `vite.config.ts:26–43`, `45–73`.
- ESLint (Vue regras): `.eslintrc.js:53–68`, `.eslintrc.js:78–97`.
- Rubocop custom: `.rubocop.yml:198–200`, `rubocop/use_from_email.rb:4–15`.
- APM por ENV: `config/application.rb:11–35`.
- Enterprise: `config/application.rb:41–53`, `config/initializers/01_inject_enterprise_edition_module.rb:23–87`.
- GIT SHA: `config/initializers/git_sha.rb:16`.

## Checklist de mudanças (PR)
- Testes: adicionar/atualizar specs RSpec/Vitest conforme domínio afetado.
- Lint: passar Rubocop/ESLint e formatar (`ruby:prettier`, `eslint:fix`).
- Segurança: sem segredos em código; variáveis via ENV; validar permissões.
- Performance: mover IO pesado para Sidekiq; escolher fila correta.
- Frontend: garantir guarda de rota e aliases; evitar strings “nuas” fora i18n.

## Observações
- Preferir editar arquivos existentes e seguir padrões do repositório.
- Controlar novas configs pelo `GlobalConfigService` e injetação em `DashboardController#set_global_config`.

## Logging & Monitoramento
- Sentry e configuração de amostragem/PII (`config/initializers/sentry.rb:1–15`).
- Rastreador de exceções (`lib/chatwoot_exception_tracker.rb:1–32`).
- Lograge em formato JSON (`config/initializers/lograge.rb:1–30`).
- Níveis/loggers por ambiente (`config/environments/development.rb:42–80`, `config/environments/production.rb:63–84`).

## Cache (Redis)
- Pools/namespaces (`config/initializers/01_redis.rb:1–18`).
- Chaves padrão (`lib/redis/redis_keys.rb:1–31`).
- Store por ambiente e null store em testes (`config/environments/test.rb:21–28`).

## Jobs & Filas
- Configuração do Sidekiq e filas (`config/initializers/sidekiq.rb:1–23`, `config/sidekiq.yml:1–39`).
- Cron jobs nomeados (`config/schedule.yml:1–55`).
- Orquestração de itens agendados (`app/jobs/trigger_scheduled_items_job.rb:1–31`).

## Mailer & Inbound
- SMTP/Resend e ingress (`config/initializers/mailer.rb:1–55`).
- Roteamento do ActionMailbox (`app/mailboxes/application_mailbox.rb:1–24`).
- Ingress em produção (`config/environments/production.rb:86–106`).

## i18n
- Troca segura de locale (`app/controllers/concerns/switch_locale.rb:46–57`).
- Locales por idioma (`config/locales/*.yml`).
- Setup de i18n em testes do frontend (`vitest.setup.js:1–17`).

## CI/CD & Deploy
- Procfiles para web/worker/vite (`Procfile*`).
- Targets de build/run/túnel (`Makefile:1–62`).
- Docker multi‑stage com assets (`Dockerfile:1–93`).
- Compose com serviços e ENV (`docker-compose.yaml:1–119`).

## Testes
- Helpers/configuração RSpec (`spec/rails_helper.rb:70–91`).
- Configuração de testes no Vite/Vitest (`vite.config.ts:41–111`).
- Scripts de testes e build no `package.json` (`package.json:1–171`).

## Feature Flags
- Flags no backend (`app/models/concerns/featurable.rb:1–71`).
- Catálogo de features (`config/features.yml:1–224`).
- Flags espelhadas no frontend (`app/javascript/dashboard/featureFlags.js:1–53`).

## Rate Limiting
- Throttles e cache com Rack::Attack (`config/initializers/rack_attack.rb:1–248`).
- Variáveis de ambiente relacionadas (`.env.example:221–227`).

## Auditoria
- Inicialização de auditoria (`config/initializers/audited.rb:1–5`).
- Modelo de auditoria (`enterprise/app/models/enterprise/audit_log.rb:1–43`).

## Criptografia & Segredos
- Active Record Encryption (`config/application.rb:65–87`).
- Chaves de criptografia via ENV (`.env.example:9–14`).
- Campos sensíveis de usuário (`app/models/user.rb:48–90`).

## Configuração Global
- Serviço e cache (`lib/global_config_service.rb:1–17`, `lib/global_config.rb:1–57`).
- Catálogo de instalação (`config/installation_config.yml:1–454`).

## SDK
- Build em modo biblioteca (`vite.config.ts:58–88`).
- Entrypoint do SDK (`app/javascript/entrypoints/sdk.js:1–19`).

## ENV & Segurança
- Convenções de variáveis (`.env.example:1–275`).
- CORS para packs/api (`config/initializers/cors.rb:6–22`).
- Content Security Policy (`config/initializers/content_security_policy.rb:1–36`).

## ActionCable
- Adapter Redis e configuração (`config/cable.yml:1–20`).
- Inicializador para ambientes com restrições (`config/initializers/actioncable.rb:5–15`).
- Canal de exemplo (`app/channels/room_channel.rb:1–59`).

## Enterprise & Injeção
- Mecanismo de injeção (`config/initializers/01_inject_enterprise_edition_module.rb:1–87`).
- Paywall/flags premium no frontend (`app/javascript/dashboard/composables/usePolicy.js:107–135`).