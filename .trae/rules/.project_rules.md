# Regras e Know‑how do Projeto

## Stack & Arquitetura
- Backend: Ruby on Rails 7 + PostgreSQL + Sidekiq (`config/application.rb:36–87`).
- Frontend: Vue 3 + Vite + integração Rails via `vite-plugin-ruby` (`vite.config.ts:21–45`).
- Autenticação/Autorização: Devise + `devise_token_auth` + Pundit; suporte 2FA/SSO.
- Tempo real: ActionCable.
- Enterprise: extensões carregadas e injetadas no boot (`config/application.rb:41–53`, `config/initializers/01_inject_enterprise_edition_module.rb:23–87`).

## Pastas‑chave (guia rápido)
- `app/controllers/**`: APIs (`api/v1`, `api/v2`, `platform`, `public`) e web.
- `app/models/**`: entidades (Account, User, Conversation, Message, Inbox, Contact...).
- `app/services/**`: regras de negócio e integrações externas.
- `app/jobs/**`: tarefas assíncronas (Sidekiq) e manutenção.
- `app/channels/**`: ActionCable.
- `app/presenters/**`: formatação de saídas.
- `app/javascript/dashboard/**`: SPA (rotas, store, componentes, helpers).
- `config/**`: rotas, ambientes, inicializadores, Sidekiq e cron.

## Fluxo Web (SPA)
- Renderização do app: `DashboardController` com layout Vue e seleção de pack (`app/controllers/dashboard_controller.rb:11`, `78–84`).
- Configuração global e versão/GIT SHA: (`app/controllers/dashboard_controller.rb:21–41`, `62–76`), `config/initializers/git_sha.rb:16`.
- Rotas SPA: `root` e `/app` rendendo dashboard (`config/routes.rb:11–19`).
- Guarda de navegação: autenticação e permissões (`app/javascript/dashboard/routes/index.js:13–27`, `29–41`; `app/javascript/dashboard/helper/routeHelpers.js:56–77`).

## Convenções (Backend)
- Controllers finos; mover regra de negócio para Service Objects (`app/services/**`).
- Autorização via Pundit nas ações sensíveis.
- Assíncrono com Sidekiq; escolher fila adequada (`config/sidekiq.yml:17–34`).
- Tarefas recorrentes em `config/schedule.yml:6–55` (IMAP, housekeeping, auto‑assignment, etc.).
- Inicializadores condicionados por ENV (APM/monitoramento) (`config/application.rb:11–35`).
- Enterprise: usar injeção por `prepend/extend/include` conforme injector (`config/initializers/01_inject_enterprise_edition_module.rb:23–87`).
- Segurança: nunca expor segredos; usar ENV e ActiveRecord Encryption quando chaves existem (`config/application.rb:72–84`).

## Convenções (Frontend)
- Vue 3 + `vue-router@4` + `Vuex@4`; manter helpers de permissões/rotas (`app/javascript/dashboard/helper/routeHelpers.js:15–18`, `40–54`, `56–77`).
- Carregar usuário antes de navegação e redirecionar não autenticados para `/app/login` (`app/javascript/dashboard/routes/index.js:13–27`).
- Aliases de import padronizados (dashboard/shared/widget etc.) (`vite.config.ts:74–87`).
- Build do SDK em modo biblioteca com `BUILD_MODE=library` gerando `public/packs/js/sdk.js` (`vite.config.ts:26–43`, `45–73`).

## Lint & Qualidade
- Ruby: Rubocop com regras e cops customizados (`.rubocop.yml:1–10`, `198–200`).
  - Cop: exigir `from_email` em buscas por e‑mail (`rubocop/use_from_email.rb:4–15`).
- JS/Vue: ESLint + Prettier + regras Vue estritas (`.eslintrc.js:53–58`, `59–68`, `78–97`, `230–236`).
- Scripts úteis: `start:dev`, `start:test`, `ruby:prettier`, `build:sdk` (`package.json:11–16`).

## Build & Execução
- Dev: usar `foreman/overmind` para Rails, Sidekiq e Vite (`package.json:11–14`).
- SDK: `pnpm run build:sdk` ou `BUILD_MODE=library vite build` (`package.json:15`, `vite.config.ts:26–43`).
- Docker: imagem multi‑stage com assets pré‑compilados e `.git_sha` (`Dockerfile:83–91`).

## Referências rápidas
- Layout Vue e pack: `app/controllers/dashboard_controller.rb:11`, `78–84`.
- Config global: `app/controllers/dashboard_controller.rb:21–41`, `62–76`.
- Rotas SPA: `config/routes.rb:11–19`.
- Guarda de rotas: `app/javascript/dashboard/routes/index.js:13–27`, `29–41`.
- Permissões por conta: `app/javascript/dashboard/helper/routeHelpers.js:56–77`.
- Filas Sidekiq: `config/sidekiq.yml:17–34`.
- Cron jobs: `config/schedule.yml:6–55`.
- SDK build: `vite.config.ts:26–43`, `45–73`.
- ESLint (Vue regras): `.eslintrc.js:53–68`, `.eslintrc.js:78–97`.
- Rubocop custom: `.rubocop.yml:198–200`, `rubocop/use_from_email.rb:4–15`.
- APM por ENV: `config/application.rb:11–35`.
- Enterprise: `config/application.rb:41–53`, `config/initializers/01_inject_enterprise_edition_module.rb:23–87`.
- GIT SHA: `config/initializers/git_sha.rb:16`.

## Checklist de mudanças (PR)
- Testes: adicionar/atualizar specs RSpec/Vitest conforme domínio afetado.
- Lint: passar Rubocop/ESLint e formatar (`ruby:prettier`, `eslint:fix`).
- Segurança: sem segredos em código; variáveis via ENV; validar permissões.
- Performance: mover IO pesado para Sidekiq; escolher fila correta.
- Frontend: garantir guarda de rota e aliases; evitar strings “nuas” fora i18n.

## Observações
- Preferir editar arquivos existentes e seguir padrões do repositório.
- Controlar novas configs pelo `GlobalConfigService` e injetação em `DashboardController#set_global_config`.